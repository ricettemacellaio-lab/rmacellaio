<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roleta Dourada - Exclusivo</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Montserrat:wght@700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS GERAIS --- */
        :root {
            --gold: #D4AF37; /* Dourado Met√°lico */
            --gold-bright: #FFD700;
            --bg-page: #050505; /* Preto Profundo */
            --bg-panel: #111111;
            --text-main: #ffffff;
            --danger: #d32f2f;
            --font-main: 'Montserrat', sans-serif; /* Fonte mais elegante */
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; margin: 0; font-family: var(--font-main); background: var(--bg-page); color: var(--text-main); overflow: hidden; }
        
        #app-container {
            width: 100%; height: 100%; max-width: 500px; margin: 0 auto;
            position: relative; background: var(--bg-page); display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.3); /* Sombra Dourada */
        }
        #fundo-overlay {
            position: absolute; width: 100%; height: 100%; top:0; left:0;
            /* Fundo Premium: Textura escura ou degrad√™ */
            background: radial-gradient(circle at center, #222, #000); 
            opacity: 1; pointer-events: none; z-index: 0;
        }
        main { flex: 1; position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }

        /* MODAIS */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(8px);
        }
        .modal-box {
            background: linear-gradient(145deg, #1a1a1a, #000); 
            width: 85%; max-width: 340px;
            padding: 30px; border-radius: 20px; border: 2px solid var(--gold);
            text-align: center; box-shadow: 0 0 50px rgba(212, 175, 55, 0.4);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-box h2 { color: var(--gold-bright); margin-top: 0; font-size: 1.5rem; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 1px; }
        .modal-box p { font-size: 1rem; color: #eee; margin-bottom: 25px; line-height: 1.6; }
        .modal-box ul { text-align: left; padding-left: 20px; font-size: 0.9rem; color: #ddd; line-height: 1.6; margin-bottom: 25px; }
        .modal-box li { margin-bottom: 10px; list-style-type: '‚ú® '; }
        
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .btn-modal { flex: 1; padding: 14px; border-radius: 50px; cursor: pointer; font-weight: bold; border: none; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 1px; }
        .btn-confirm { 
            background: linear-gradient(90deg, var(--gold), var(--gold-bright), var(--gold)); 
            color: #000; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }
        .btn-cancel { background: transparent; border: 1px solid #555; color: #fff; }

        /* HEADER */
        .header-title { 
            color: var(--gold-bright); font-size: 2rem; font-weight: 900; 
            text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; 
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.6); text-align: center;
            cursor: pointer; user-select: none; line-height: 1.1; font-family: 'Playfair Display', serif;
        }
        .status-pill { border: 1px solid var(--gold); color: var(--gold-bright); padding: 8px 20px; border-radius: 50px; font-size: 0.9rem; font-weight: 700; margin-bottom: 30px; background: rgba(0,0,0,0.8); box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }
        
        /* ROLETA */
        #roleta-container { position: relative; width: 320px; height: 320px; margin-bottom: 60px; margin-top: 10px; }
        #roleta-wrapper { width: 100%; height: 100%; border-radius: 50%; position: relative; overflow: hidden; border: 8px solid var(--gold); box-shadow: 0 0 60px rgba(212, 175, 55, 0.3); transform: rotate(0deg); z-index: 5; }
        
        /* Ponteiro (TOPO) */
        #ponteiro { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 25px solid transparent; border-right: 25px solid transparent; border-top: 60px solid #fff; z-index: 25; filter: drop-shadow(0 4px 10px rgba(255,255,255,0.5)); }

        .segmento { position: absolute; top: 0; right: 0; width: 50%; height: 50%; transform-origin: 0% 100%; overflow: hidden; }
        .seg-conteudo { position: absolute; left: -100%; width: 200%; height: 200%; text-align: center; padding-top: 45px; font-size: 0.8rem; font-weight: 800; color: #000; text-shadow: 0 1px 0 rgba(255,255,255,0.4); display: flex; justify-content: center; }
        .seg-conteudo span { display: block; width: 80px; line-height: 1.1; }

        /* CENTRO & DARDO */
        #centro-roleta { position: absolute; top: 48%; left: 50%; width: 60px; height: 60px; border-radius: 50%; transform: translate(-50%, -50%); z-index: 10; background: #000; border: 4px solid var(--gold); box-shadow: 0 0 30px rgba(212, 175, 55, 0.5); }
        
        #projectile-dart { position: absolute; bottom: -150px; left: 50%; transform: translateX(-50%) rotate(180deg); font-size: 80px; z-index: 30; display: none; pointer-events: none; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.8)); }
        @keyframes dartTrajectoryCenter { 0% { bottom: -150px; transform: translateX(-50%) scale(1.0); opacity: 1; } 100% { bottom: 135px; transform: translateX(-50%) scale(0.9); opacity: 1; } }
        .flying-dart-anim { animation: dartTrajectoryCenter 0.35s cubic-bezier(0.2, 0.8, 0.4, 1) forwards; }
        
        #dardo-preso { position: absolute; top: 48%; left: 50%; width: 0; height: 0; z-index: 35; display: none; pointer-events: none; }
        #dardo-preso::after { content: 'üéØ'; font-size: 50px; position: absolute; top: -168px; left: -04px; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.8)); }

        /* BOT√ïES */
        .btn-gold { background: linear-gradient(180deg, var(--gold-bright), var(--gold)); color: #000; font-size: 1.2rem; font-weight: 900; text-transform: uppercase; border: none; padding: 20px 0; border-radius: 50px; cursor: pointer; box-shadow: 0 0 30px rgba(212, 175, 55, 0.3); width: 90%; max-width: 320px; transition: transform 0.1s; position: relative; z-index: 101; letter-spacing: 1px; }
        .btn-gold:active { transform: scale(0.96); }
        .btn-throw { background: #fff; color: #000; box-shadow: 0 0 30px rgba(255, 255, 255, 0.4); }
        .btn-outline { background: transparent; border: 2px solid var(--gold); color: var(--gold); padding: 12px 25px; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 0.9rem; text-transform: uppercase; }

        /* TELAS */
        .tela { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .tela.ativa { display: flex; animation: fadeIn 0.8s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .resgate-card { background: linear-gradient(145deg, #1c1c1c, #000); padding: 40px 25px; border-radius: 20px; border: 1px solid var(--gold); text-align: center; width: 90%; box-shadow: 0 0 50px rgba(212, 175, 55, 0.2); }
        .cupom-box { background: #000; border: 2px dashed var(--gold); color: var(--gold-bright); font-size: 2.5rem; padding: 20px; margin: 25px 0; font-weight: 900; letter-spacing: 3px; border-radius: 10px; text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        .aviso-legal { font-size: 0.7rem; color: #888; margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; width: 100%; }

        /* ADMIN */
        #tela-admin { justify-content: flex-start; padding-top: 20px; background: #0a0a0a; z-index: 200; overflow-y: auto; }
        .admin-section { background: #1c1c1c; width: 95%; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #333; }
        .premio-row { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; }
        .input-admin { background: #fff; color: #333; border: 1px solid #ccc; padding: 8px; border-radius: 4px; width: 100%; }
        .col-nome { flex: 2; } .col-cupom { flex: 1.5; } .col-peso { flex: 0.8; }
        .btn-remove { background: var(--danger); color: white; border: none; width: 30px; height: 30px; border-radius: 4px; font-weight: bold; }
        .btn-add, .btn-save { border: none; padding: 10px; width: 48%; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .btn-add { background: #e0e0e0; color: #333; } .btn-save { background: #900; color: #fff; }
        .hidden { display: none !important; }
        .link-result { margin-top:10px; padding:10px; background:#004d40; color:#fff; font-size:0.8rem; border-radius:5px; word-break:break-all; display:none; }
        .color-picker-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .color-input { width: 50px; height: 30px; border: none; padding: 0; cursor: pointer; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="fundo-overlay"></div>

    <div id="modal-welcome" class="modal-overlay hidden">
        <div class="modal-box" style="border-color: #fff;">
            <h1 style="color:var(--gold-bright); font-size:3rem; margin:0;">üéâ</h1>
            <h2 style="color: #fff;">PARAB√âNS!</h2>
            <p style="color: #ccc; font-size: 1.1rem;">Voc√™ foi selecionado para a <strong>ROLETA DOURADA</strong>.</p>
            <p style="color: var(--gold); font-weight: bold;">Pr√™mios exclusivos e maiores chances para clientes especiais como voc√™.</p>
            <button class="btn-modal btn-confirm" style="background: #fff; color: #000;" onclick="fecharWelcome()">ACESSAR AGORA</button>
        </div>
    </div>

    <div id="modal-tutorial" class="modal-overlay hidden">
        <div class="modal-box">
            <h2>Regras Douradas</h2>
            <ul>
                <li>üîí <strong>Acesso VIP:</strong> Link √∫nico e exclusivo.</li>
                <li>üíé <strong>5 Chances:</strong> Voc√™ tem 5 giros dispon√≠veis.</li>
                <li>‚ö° <strong>Risco Real:</strong> Casas brancas n√£o t√™m pr√™mio. Cuidado!</li>
                <li>üîÑ <strong>Girar de Novo:</strong> Descarta o pr√™mio anterior.</li>
            </ul>
            <button class="btn-modal btn-confirm" onclick="fecharModal('modal-tutorial')">COME√áAR O JOGO</button>
        </div>
    </div>

    <div id="modal-confirm-resgate" class="modal-overlay hidden">
        <div class="modal-box">
            <h2>Garantir Pr√™mio?</h2>
            <p>Ao confirmar, voc√™ leva para casa: <br><strong id="premio-resgate-nome" style="color:var(--gold-bright); font-size:1.3rem;"></strong></p>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="fecharModal('modal-confirm-resgate')">VOLTAR</button>
                <button class="btn-modal btn-confirm" onclick="confirmarResgate()">RESGATAR</button>
            </div>
        </div>
    </div>

    <div id="modal-confirm-spin" class="modal-overlay hidden">
        <div class="modal-box">
            <h2 style="color: var(--danger);">Tem certeza?</h2>
            <p>Voc√™ <strong>PERDE</strong> o pr√™mio atual (<span id="premio-perdido-nome" style="color:var(--gold); font-weight:bold;"></span>) e arrisca cair numa casa vazia.</p>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="fecharModal('modal-confirm-spin')">CANCELAR</button>
                <button class="btn-modal btn-confirm" onclick="confirmarNovoGiro()">ARRISCAR</button>
            </div>
        </div>
    </div>

    <div id="tela-jogo" class="tela">
        <div class="header-title" id="display-title" onclick="verificarSegredo()">ROLETA DOURADA</div>
        <div class="status-pill" id="contador-giros">Carregando...</div>

        <div id="roleta-container">
            <div id="ponteiro"></div>
            <div id="roleta-wrapper"></div>
            <div id="centro-roleta"></div>
            <div id="dardo-preso"></div>
            <div id="projectile-dart">üéØ</div>
        </div>

        <button id="btn-girar" class="btn-gold" onclick="iniciarGiroMotor()">GIRAR AGORA</button>
        <button id="btn-arremessar" class="btn-gold btn-throw hidden" onclick="arremessarDardo()">ATIRAR DARDO!</button>

        <div id="msg-resultado" class="hidden" style="margin-top:20px; text-align:center;">
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:5px;">O dardo marcou:</p>
            <h3 id="txt-premio-atual" style="color:var(--gold-bright); font-size:1.8rem; margin:0 0 20px 0; text-shadow: 0 0 10px rgba(212,175,55,0.5);">...</h3>
            <button id="btn-resgatar-home" class="btn-gold" style="padding:15px 30px; font-size:1rem; width:auto;" onclick="abrirConfirmacaoResgate()">GARANTIR PR√äMIO</button>
            <button id="btn-girar-dnv" class="btn-outline" style="margin-left:10px;" onclick="abrirConfirmacaoGiro()">TENTAR MELHOR</button>
        </div>
    </div>

    <div id="tela-resgate" class="tela">
        <div class="resgate-card">
            <h2 style="color:var(--gold-bright); margin:0; font-size: 2rem;">üèÜ PARAB√âNS!</h2>
            <p style="color:#ddd; font-size:1rem;">Voc√™ garantiu um pr√™mio exclusivo.</p>
            <h3 id="resgate-nome" style="font-size:1.6rem; margin:20px 0 5px 0; color: #fff;">...</h3>
            <div class="cupom-box" id="resgate-cupom">...</div>
            
            <p style="font-size:0.8rem; color:#fff; margin-bottom:20px;">V√°lido at√©: <span id="resgate-data"></span></p>
            
            <button onclick="copiarCodigo()" class="btn-gold" style="width:100%; margin-bottom:15px;">COPIAR C√ìDIGO</button>
            <a id="btn-resgate-link" href="#" target="_blank" class="btn-gold" style="background:#fff; color:#000; width:100%; line-height:50px; padding:0;">USAR AGORA</a>
            
            <div class="aviso-legal">Aten√ß√£o: Uso √∫nico e intransfer√≠vel.</div>
        </div>
    </div>

    <div id="tela-bloqueio" class="tela">
        <h2 style="color:var(--danger);">ACESSO NEGADO</h2>
        <p style="color:#ccc; text-align:center;">Link inv√°lido ou expirado.</p>
    </div>

    <div id="tela-admin" class="tela">
        <div class="header-title" style="font-size:1.2rem; margin-top:20px;">ADMIN VIP</div>
        <div class="admin-section">
            <h3>Pr√™mios da Roleta Dourada</h3>
            <p style="font-size:0.7rem; color:#aaa;">Padr√£o: Ouro e Branco alternados.</p>
            <div style="display:flex; gap:5px; font-size:0.7rem; color:#888; margin-bottom:5px;">
                <span style="flex:2">NOME</span><span style="flex:1.5">CUPOM</span><span style="flex:0.5">COR</span><span style="flex:0.8">PESO</span>
            </div>
            <div id="lista-premios"></div>
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button onclick="adicionarPremio()" class="btn-add">+ ITEM</button>
                <button onclick="salvarConfigAdmin()" class="btn-save">SALVAR</button>
            </div>
        </div>
        <div class="admin-section">
            <h3>Configura√ß√µes</h3>
            <label style="color:#ccc; font-size:0.8rem;">Link "Usar Agora":</label>
            <input type="text" id="custom-redeem-url" class="input-admin" placeholder="https://...">
            <label style="color:#ccc; font-size:0.8rem; margin-top:10px;">√Åudio Vit√≥ria:</label>
            <input type="text" id="custom-voice-url" class="input-admin" placeholder="URL MP3">
        </div>
        <div class="admin-section">
            <h3>Gerar Campanha</h3>
            <input type="text" id="campanha-nome" class="input-admin" placeholder="Nome">
            <button onclick="gerarLink()" class="btn-gold" style="font-size:0.8rem; padding:10px; margin-top:10px;">GERAR LINK</button>
            <div id="resultado-link" class="link-result"></div>
        </div>
        <br><br>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let spinOscillator = null, spinGain = null;
    function startSpinSound(){ if(audioCtx.state==='suspended')audioCtx.resume();if(spinOscillator)return;spinOscillator=audioCtx.createOscillator();spinGain=audioCtx.createGain();spinOscillator.connect(spinGain);spinGain.connect(audioCtx.destination);spinOscillator.type='sawtooth';spinOscillator.frequency.setValueAtTime(50,audioCtx.currentTime);spinGain.gain.setValueAtTime(0.08,audioCtx.currentTime);spinOscillator.start();}
    function stopSpinSound(){if(spinOscillator){spinGain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.05);spinOscillator.stop(audioCtx.currentTime+0.05);spinOscillator=null;spinGain=null;}}
    function playThud(){if(audioCtx.state==='suspended')audioCtx.resume();const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.setValueAtTime(120,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(30,audioCtx.currentTime+0.15);g.gain.setValueAtTime(1.0,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.15);o.type='square';o.start();o.stop(audioCtx.currentTime+0.15);}
    function playWin(){
        if(styleAtual.voiceUrl&&styleAtual.voiceUrl.trim()!==""){const v=new Audio(styleAtual.voiceUrl);v.volume=1.0;v.play().catch(e=>playSynthWin());}else{playSynthWin();}
    }
    function playSynthWin(){const n=audioCtx.currentTime;[523,659,784,1046].forEach((f,i)=>{const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.value=f;g.gain.setValueAtTime(0,n+i*0.1);g.gain.linearRampToValueAtTime(0.2,n+i*0.1+0.1);g.gain.exponentialRampToValueAtTime(0.001,n+i*0.1+1.5);o.start(n+i*0.1);o.stop(n+i*0.1+1.5);});}

    // CONFIGURA√á√ÉO DOURADA (Alternada)
    const DEFAULT_PREMIOS = [
        { nome: "R$ 50,00 OFF", cupom: "OURO50", cor: "#D4AF37", peso: 5 }, // Ouro
        { nome: "Sem Pr√™mio", cupom: "", cor: "#FFFFFF", peso: 30 },        // Branco
        { nome: "Combo Fam√≠lia", cupom: "FAMILIA", cor: "#D4AF37", peso: 5 }, // Ouro
        { nome: "Tente de Novo", cupom: "", cor: "#FFFFFF", peso: 30 },      // Branco
        { nome: "Frete Gr√°tis", cupom: "FRETEVIP", cor: "#D4AF37", peso: 20 }, // Ouro
        { nome: "Sem Pr√™mio", cupom: "", cor: "#FFFFFF", peso: 30 }          // Branco
    ];
    
    // Estilo Fixo Dourado
    const DEFAULT_STYLE = {
        title: "ROLETA DOURADA",
        bgUrl: "", // Usa o CSS radial-gradient padr√£o
        mainColor: "#D4AF37",
        bgColor: "#050505",
        font: "'Playfair Display', serif",
        vipUrl: "", // N√£o usa
        redeemUrl: "https://www.rmacellaio.com.br",
        voiceUrl: "https://ricettemacellaio-lab.github.io/rmacellaio/assets/voz-vitoria.mp3"
    };

    let premiosAtuais, styleAtual, estado = { campanha: null, giros: 0, maxGiros: 5, resgatado: false, premioFinal: null, dataResgate: null }; // 5 Giros
    let rotationAngle=0, velocity=0, mode='IDLE', animFrame=null, targetPrizeIndex=-1, segredoClicks=0, flyingFrames=0;

    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('admin')==='1'||params.get('admin')==='true'){
            try{ const sP=localStorage.getItem('gold_admin_premios'); premiosAtuais=sP?JSON.parse(sP):DEFAULT_PREMIOS;
                 const sS=localStorage.getItem('gold_admin_style'); styleAtual=sS?JSON.parse(sS):DEFAULT_STYLE;
            }catch(e){premiosAtuais=DEFAULT_PREMIOS;styleAtual=DEFAULT_STYLE;}
            abrirAdmin(); return;
        }
        const enc=params.get('d'); if(enc){ try{const d=JSON.parse(decodeURIComponent(atob(enc))); premiosAtuais=d.premios||DEFAULT_PREMIOS; styleAtual=d.style||DEFAULT_STYLE;}catch(e){premiosAtuais=DEFAULT_PREMIOS;styleAtual=DEFAULT_STYLE;} } else { premiosAtuais=DEFAULT_PREMIOS; styleAtual=DEFAULT_STYLE; }
        
        aplicarEstilo(styleAtual);
        const c=params.get('c'); if(!c){ mostrarTela('tela-bloqueio'); return;}
        estado.campanha=c; carregarEstadoUsuario();
        
        // FLUXO DE MODAIS
        const temEstado = localStorage.getItem(getKey());
        if(!temEstado) {
            document.getElementById('modal-welcome').classList.remove('hidden'); // 1. Boas vindas
        } else {
            // Se j√° jogou, vai direto
            checkGameState();
        }
    };

    function fecharWelcome(){ document.getElementById('modal-welcome').classList.add('hidden'); document.getElementById('modal-tutorial').classList.remove('hidden'); }
    function fecharModal(id){ document.getElementById(id).classList.add('hidden'); if(id==='modal-tutorial') checkGameState(); }

    function checkGameState(){
        if(estado.resgatado||(estado.giros>=estado.maxGiros&&estado.premioFinal)){
            if(!estado.resgatado){ estado.resgatado=true; if(!estado.dataResgate)estado.dataResgate=new Date().toISOString(); salvarEstadoUsuario(); }
            montarTelaResgate(); mostrarTela('tela-resgate');
        } else { renderizarRoleta(); atualizarUI(); mostrarTela('tela-jogo'); }
    }

    function abrirConfirmacaoResgate(){ if(estado.premioFinal)document.getElementById('premio-resgate-nome').innerText=estado.premioFinal.nome; document.getElementById('modal-confirm-resgate').classList.remove('hidden'); }
    function confirmarResgate(){ fecharModal('modal-confirm-resgate'); irResgate(); }
    function abrirConfirmacaoGiro(){ document.getElementById('premio-perdido-nome').innerText=estado.premioFinal?estado.premioFinal.nome:"..."; document.getElementById('modal-confirm-spin').classList.remove('hidden'); }
    function confirmarNovoGiro(){ fecharModal('modal-confirm-spin'); resetarJogo(); }

    function aplicarEstilo(s){
        document.documentElement.style.setProperty('--gold', s.mainColor);
        document.documentElement.style.setProperty('--bg-page', s.bgColor);
        document.body.style.fontFamily = s.font;
        if(s.title){ document.getElementById('display-title').innerText=s.title; document.title=s.title; }
        if(s.bgUrl&&s.bgUrl!=="")document.getElementById('fundo-overlay').style.backgroundImage=`url('${s.bgUrl}')`;
        document.getElementById('btn-resgate-link').href = s.redeemUrl;
    }

    /* GAME LOGIC */
    function iniciarGiroMotor(){ if(estado.giros>=estado.maxGiros)return; if(audioCtx.state==='suspended')audioCtx.resume(); document.getElementById('btn-girar').classList.add('hidden'); document.getElementById('btn-arremessar').classList.remove('hidden'); mode='MOTOR'; velocity=0; loopFisica(); startSpinSound(); }
    function arremessarDardo(){ if(mode!=='MOTOR')return; document.getElementById('btn-arremessar').classList.add('hidden'); const p=document.getElementById('projectile-dart'); p.style.display='block'; p.classList.add('flying-dart-anim');
        let tp=premiosAtuais.reduce((s,x)=>s+(parseInt(x.peso)||0),0); let r=Math.random()*tp; let c=0; targetPrizeIndex=0;
        if(tp>0){ for(let i=0;i<premiosAtuais.length;i++){ c+=(parseInt(premiosAtuais[i].peso)||0); if(r<c){targetPrizeIndex=i;break;} } }
        else { targetPrizeIndex=Math.floor(Math.random()*premiosAtuais.length); }
        const arc=360/premiosAtuais.length; const cAng=(targetPrizeIndex*arc)+(arc/2); let tRot=360-cAng; const cMod=rotationAngle%360; let diff=tRot-cMod; if(diff<0)diff+=360;
        const frames=22; const dist=diff+360; velocity=dist/frames; flyingFrames=22; mode='FLYING';
    }
    function impactoDardo(){ mode='FINISHED'; stopSpinSound(); playThud(); document.getElementById('projectile-dart').style.display='none'; 
        const dp=document.getElementById('dardo-preso'); dp.style.display='block';
        const arc=360/premiosAtuais.length; const cAng=(targetPrizeIndex*arc)+(arc/2); rotationAngle=360-cAng;
        document.getElementById('roleta-wrapper').style.transform=`rotate(${rotationAngle}deg)`; finalizarJogo();
    }
    function loopFisica(){ if(mode==='IDLE'||mode==='FINISHED')return; if(mode==='MOTOR'){ if(velocity<25)velocity+=0.8; rotationAngle+=velocity; } else if(mode==='FLYING'){ rotationAngle+=velocity; flyingFrames--; if(flyingFrames<=0)impactoDardo(); } document.getElementById('roleta-wrapper').style.transform=`rotate(${rotationAngle}deg)`; animFrame=requestAnimationFrame(loopFisica); }
    function finalizarJogo(){ cancelAnimationFrame(animFrame); playWin(); const prz=premiosAtuais[targetPrizeIndex];
        setTimeout(()=>{ estado.giros++;
            if(!prz.cupom||prz.cupom.trim()===""){ document.getElementById('txt-premio-atual').innerText="N√£o foi dessa vez!"; estado.premioFinal=null; }
            else{ estado.premioFinal=prz; document.getElementById('txt-premio-atual').innerText=prz.nome; }
            salvarEstadoUsuario(); atualizarUI(); document.getElementById('msg-resultado').classList.remove('hidden');
            if(estado.giros>=estado.maxGiros){ document.getElementById('btn-girar-dnv').classList.add('hidden'); if(!estado.premioFinal)document.getElementById('btn-resgatar-home').classList.add('hidden'); }
        },800);
    }
    function resetarJogo(){ if(estado.giros>=estado.maxGiros)return; document.getElementById('msg-resultado').classList.add('hidden'); document.getElementById('btn-girar').classList.remove('hidden'); document.getElementById('dardo-preso').style.display='none'; document.getElementById('projectile-dart').classList.remove('flying-dart-anim'); }

    /* UTIL */
    function verificarSegredo(){ segredoClicks++; if(segredoClicks>=5){ alert("Admin!"); abrirAdmin(); }}
    function abrirAdmin(){ document.getElementById('tela-admin').classList.add('ativa'); document.getElementById('tela-jogo').classList.remove('ativa'); document.getElementById('tela-bloqueio').classList.remove('ativa'); renderAdminPremios(); 
        document.getElementById('custom-redeem-url').value=styleAtual.redeemUrl; document.getElementById('custom-voice-url').value=styleAtual.voiceUrl; }
    function renderAdminPremios(){ const l=document.getElementById('lista-premios'); l.innerHTML=''; premiosAtuais.forEach((p,i)=>{ const d=document.createElement('div'); d.className='premio-row'; d.innerHTML=`<input type="text" class="input-admin col-nome" value="${p.nome}" id="n-${i}"><input type="text" class="input-admin col-cupom" value="${p.cupom}" id="c-${i}"><input type="color" class="color-input" value="${p.cor}" id="k-${i}"><input type="number" class="input-admin col-peso" value="${p.peso}" id="p-${i}"><button class="btn-remove" onclick="rmP(${i})">X</button>`; l.appendChild(d); }); }
    function adicionarPremio(){ saveM(); premiosAtuais.push({nome:"",cupom:"",peso:0,cor:"#FFFFFF"}); renderAdminPremios(); }
    function rmP(i){ if(premiosAtuais.length<=2)return; if(confirm("Rm?")){ saveM(); premiosAtuais.splice(i,1); renderAdminPremios(); } }
    function saveM(){ premiosAtuais.forEach((p,i)=>{ const n=document.getElementById(`n-${i}`); if(n)p.nome=n.value; const c=document.getElementById(`c-${i}`); if(c)p.cupom=c.value; const k=document.getElementById(`k-${i}`); if(k)p.cor=k.value; const w=document.getElementById(`p-${i}`); let wv=parseInt(w.value); if(isNaN(wv))wv=0; p.peso=wv; }); styleAtual.redeemUrl=document.getElementById('custom-redeem-url').value; styleAtual.voiceUrl=document.getElementById('custom-voice-url').value; }
    function salvarConfigAdmin(){ saveM(); localStorage.setItem('gold_admin_premios',JSON.stringify(premiosAtuais)); localStorage.setItem('gold_admin_style',JSON.stringify(styleAtual)); alert("Salvo!"); }
    function gerarLink(){ const n=document.getElementById('campanha-nome').value.replace(/\s/g,'').toUpperCase(); if(!n)return alert("Nome?"); saveM(); const full={premios:premiosAtuais,style:styleAtual}; const json=JSON.stringify(full); const enc=btoa(encodeURIComponent(json)); const u=`${location.origin}${location.pathname}?c=${n}&d=${enc}`; document.getElementById('resultado-link').style.display='block'; document.getElementById('resultado-link').innerHTML=`Link Gold:<br><a href="${u}" style="color:#fff; word-break:break-all;">${u}</a>`; }
    function renderizarRoleta(){ const w=document.getElementById('roleta-wrapper'); w.innerHTML=''; const tot=premiosAtuais.length; const arc=360/tot; premiosAtuais.forEach((p,i)=>{ const s=document.createElement('div'); s.className='segmento'; const r=i*arc; const sk=90-arc; s.style.transform=`rotate(${r}deg) skewY(-${sk}deg)`; s.style.backgroundColor=p.cor; const c=document.createElement('div'); c.className='seg-conteudo'; c.style.transform=`skewY(${sk}deg) rotate(${arc/2}deg)`; c.innerHTML=`<span style="color:${p.cor==='#FFFFFF'?'#000':'#FFF'}">${p.nome}</span>`; s.appendChild(c); w.appendChild(s); }); }
    function irResgate(){ if(!estado.premioFinal)return; estado.resgatado=true; estado.dataResgate=new Date().toISOString(); salvarEstadoUsuario(); montarTelaResgate(); mostrarTela('tela-resgate'); }
    function montarTelaResgate(){ const p=estado.premioFinal; document.getElementById('resgate-nome').innerText=p.nome; document.getElementById('resgate-cupom').innerText=p.cupom; const d=new Date(estado.dataResgate); d.setDate(d.getDate()+30); document.getElementById('resgate-data').innerText=d.toLocaleDateString('pt-BR'); }
    function atualizarUI(){ document.getElementById('contador-giros').innerText=`Jogada ${estado.giros+1} de ${estado.maxGiros}`; if(estado.giros>=estado.maxGiros)document.getElementById('contador-giros').innerText="√öltima Jogada!"; }
    function mostrarTela(id){ document.querySelectorAll('.tela').forEach(t=>t.classList.remove('ativa')); document.getElementById(id).classList.add('ativa'); }
    function getKey(){ return `macellaio_gold_user_${estado.campanha}`; }
    function salvarEstadoUsuario(){ localStorage.setItem(getKey(), JSON.stringify(estado)); }
    function carregarEstadoUsuario(){ const s=localStorage.getItem(getKey()); if(s)Object.assign(estado, JSON.parse(s)); }
    function copiarCodigo(){ navigator.clipboard.writeText(document.getElementById('resgate-cupom').innerText); alert("Copiado!"); }
</script>
</body>
</html>
